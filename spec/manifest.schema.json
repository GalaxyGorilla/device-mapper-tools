{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.invalid/device-mapper-tools/manifest.schema.json",
  "title": "device-mapper-tools manifest",
  "type": "object",
  "required": ["manifest_version", "images", "stack"],
  "properties": {
    "manifest_version": {
      "type": "integer",
      "const": 1
    },
    "created_utc": {
      "type": "string",
      "description": "ISO-8601 timestamp"
    },
    "images": {
      "type": "object",
      "required": ["data"],
      "properties": {
        "data": {"$ref": "#/$defs/image"},
        "integrity_meta": {"$ref": "#/$defs/image"},
        "crypt_header": {"$ref": "#/$defs/image"},
        "verity_hash": {"$ref": "#/$defs/image"}
      },
      "additionalProperties": true
    },
    "integrity": {
      "type": "object",
      "description": "dm-integrity parameters used to format the integrity_meta image",
      "properties": {
        "compat": {"type": "string", "enum": ["v1"]},
        "tag_size": {"type": "integer", "minimum": 1},
        "block_size": {"type": "integer", "enum": [512, 1024, 2048, 4096]},
        "mode": {"type": "string", "enum": ["J", "B", "D", "R"]},
        "buffer_sectors": {"type": "integer", "minimum": 1}
      },
      "additionalProperties": true
    },
    "crypt": {
      "type": "object",
      "description": "dm-crypt parameters for first-boot activation",
      "properties": {
        "mode": {"type": "string", "enum": ["plain", "aead"]},
        "cipher": {"type": "string"},
        "key_bytes": {"type": "integer", "minimum": 1},
        "sector_size": {"type": "integer", "minimum": 1},
        "iv_offset": {"type": "integer"},
        "aead": {
          "type": "object",
          "properties": {
            "tag_size": {"type": "integer", "minimum": 1}
          },
          "additionalProperties": true
        }
      },
      "additionalProperties": true
    },
    "verity": {
      "type": "object",
      "description": "dm-verity parameters and root hash for activation",
      "properties": {
        "hash_alg": {"type": "string"},
        "data_block_size": {"type": "integer", "minimum": 1},
        "hash_block_size": {"type": "integer", "minimum": 1},
        "salt_hex": {"type": "string"},
        "root_hash_hex": {"type": "string"}
      },
      "additionalProperties": true
    },
    "stack": {
      "type": "array",
      "description": "Bottom-to-top stack of device-mapper layers",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["type"],
        "properties": {
          "type": {
            "type": "string",
            "enum": ["raw", "dm-integrity", "dm-crypt", "dm-verity"]
          },
          "name": {"type": "string"},
          "params": {"type": "object", "additionalProperties": true}
        },
        "additionalProperties": false
      }
    },
    "firstboot": {
      "type": "object",
      "description": "Actions that must be performed on the target device on first boot",
      "properties": {
        "required": {"type": "boolean"},
        "notes": {"type": "string"}
      },
      "additionalProperties": true
    }
  },
  "$defs": {
    "image": {
      "type": "object",
      "required": ["path", "bytes"],
      "properties": {
        "path": {"type": "string"},
        "bytes": {"type": "integer", "minimum": 0},
        "sha256": {"type": "string", "pattern": "^[0-9a-f]{64}$"}
      },
      "additionalProperties": false
    }
  }
}
